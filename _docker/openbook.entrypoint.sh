#! /bin/sh

# NOTE: The server is started using exec to replace the shell process with the new process.
# This makes sure that the process receives the OS signals generated by Docker, especially
# SIGTERM, when the container is being stopped. See :https://unix.stackexchange.com/a/196053

if [ -n "$1" ]; then
    echo ">>> Starting worker process: $1 <<<"
    exec ../.env/bin/python ./manage.py runworker "$1"
else
    echo ">>> Starting OpenBook Server <<<"

    mkdir -p _static
    cp -r _static/* _static.volume

    ../.env/bin/python ./manage.py migrate

    if [ -n "$OB_LOAD_INITIAL_DATA" ]; then
        ../.env/bin/python ./manage.py load_initial_data
    fi

    if [! -z "$OB_SERVER_URL"]; then
        echo ">>> Using server URL: $OB_SERVER_URL <<<"
        echo ">>> Please make sure this URL can be accessed from the browser. <<<"
        echo "$OB_SERVER_URL" > _static.volume/openbook/website/server.url
    fi

    exec ../.env/bin/daphne -p 8000 -b 0.0.0.0 openbook.asgi:application
fi
